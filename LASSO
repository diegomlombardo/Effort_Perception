% Assuming these variables exist:
% X = [X_norm, head_norm];  % predictors
% y = y_clean;              % response
% group_names = {...};      % cell array of ROI names, length = num_groups

k = 10;
cv = cvpartition(y, 'KFold', k);

% To store results
coef_all = zeros(size(X,2), k);
intercept_all = zeros(k,1);
y_pred_all = nan(size(y));

for fold = 1:k
    trainIdx = training(cv, fold);
    testIdx = test(cv, fold);

    fprintf('Fold %d:\n', fold);
    fprintf(' Training samples: %d\n', sum(trainIdx));
    fprintf(' Test samples: %d\n', sum(testIdx));

    % Prepare training and test sets
    X_train = X(trainIdx, :);
    y_train = y(trainIdx);
    X_test = X(testIdx, :);
    y_test = y(testIdx);

    % Perform LASSO with internal CV on training set only (optional: you can fix lambda or run another CV here)
    [B, FitInfo] = lasso(X_train, y_train, 'CV', 5);  % inner CV to select lambda
    idxLambdaMinMSE = FitInfo.IndexMinMSE;
    coef = B(:, idxLambdaMinMSE);
    intercept = FitInfo.Intercept(idxLambdaMinMSE);

    % Store coefficients
    coef_all(:, fold) = coef;
    intercept_all(fold) = intercept;

    % Predict on test fold
    y_pred_fold = X_test * coef + intercept;
    y_pred_all(testIdx) = y_pred_fold;

    % Show selected features for this fold
    selected = find(coef ~= 0);
    fprintf(' Selected predictors in fold %d:\n', fold);
    for i = 1:length(selected)
        if selected(i) <= num_groups
            fprintf('  ROI: %s, Coef = %.4f\n', group_names{selected(i)}, coef(selected(i)));
        else
            fprintf('  Head Motion, Coef = %.4f\n', coef(selected(i)));
        end
    end
    fprintf('\n');
end

% Compute overall R² on all samples based on CV predictions
SS_res = sum((y - y_pred_all).^2);
SS_tot = sum((y - mean(y)).^2);
R2_cv = 1 - SS_res / SS_tot;

fprintf('Cross-validated LASSO R²: %.4f\n', R2_cv);

% Plot observed vs predicted (CV)
figure('Color','w');
scatter(y, y_pred_all, 70, 'filled', 'MarkerFaceColor', [0 0.4470 0.7410]);
xlabel('Observed PES Total');
ylabel('Predicted PES Total (LASSO CV)');
title(sprintf('LASSO Cross-Validated Fit\nR^2 = %.3f', R2_cv));
grid on;
axis equal;
refline(1,0);
xlim([min(y) max(y)]);
ylim([min(y_pred_all) max(y_pred_all)]);
set(gca, 'FontSize', 14, 'LineWidth', 1.2);
box on;
